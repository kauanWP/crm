<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Envio de Mensagens WhatsApp</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f2f5;
      padding: 20px;
      max-width: 700px;
      margin: auto;
    }
    h2, h3 {
      color: #333;
    }
    label {
      font-weight: 600;
      margin-top: 10px;
      display: block;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 15px;
      box-sizing: border-box;
      font-size: 15px;
      background-color: #fff;
    }
    textarea {
      resize: vertical;
    }
    button {
      background-color: #007bff;
      color: white;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    button:hover:enabled {
      background-color: #0056b3;
    }
    pre {
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 300px;
      overflow-y: auto;
    }
    #statusEnvio {
      font-weight: bold;
      color: green;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .hidden {
      display: none;
    }
    .status-container {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #007bff;
    }
    .status-whatsapp {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .status-indicator {
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 14px;
    }
    .status-connected {
      background: #d4edda;
      color: #155724;
    }
    .status-disconnected {
      background: #f8d7da;
      color: #721c24;
    }
    .status-checking {
      background: #fff3cd;
      color: #856404;
    }
    #btnConectarWhatsApp {
      background-color: #25D366;
    }
    #btnConectarWhatsApp:hover {
      background-color: #1da851;
    }
    .btn-small {
      padding: 8px 16px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>Enviar mensagens via WhatsApp</h2>

  <!-- Seção de Status do WhatsApp -->
  <div class="status-container">
    <div class="status-whatsapp">
      <div>
        <strong>Status do WhatsApp:</strong>
        <span id="statusText" class="status-indicator status-checking">Verificando...</span>
      </div>
      <button id="btnConectarWhatsApp" class="btn-small">Conectar WhatsApp</button>
    </div>
    <div id="statusDetails" style="font-size: 14px; color: #666;">
      Conecte seu WhatsApp para começar a enviar mensagens
    </div>
  </div>

  <label for="titulo">Título (para arquivo histórico)</label>
  <textarea id="titulo" placeholder="Título da mensagem (opcional)"></textarea>

  <label for="rota">Tipo de Envio:</label>
  <select id="rota">
    <option value="mensagem">Mensagem Simples</option>
    <option value="imagem">Mensagem com Imagem</option>
    <option value="mensagem-dupla">Mensagem Dupla (sem imagem)</option>
    <option value="mensagem-boleto">Mensagem + Boleto + Legenda</option>
    <option value="boleto">Somente Boleto</option>
  </select>

  <label for="vendedor">Deseja Enviar de qual número?:</label>
  <select id="vendedor">
    <option value="Financeiro">Financeiro</option>
  </select>

  <label for="numeros">Números (um por linha):</label>
  <textarea id="numeros" rows="4" placeholder="Ex: 5511999999999"></textarea>

  <label for="mensagem1">Mensagem 1:</label>
  <textarea id="mensagem1" placeholder="Mensagem principal"></textarea>

  <div id="divMensagem2" class="hidden">
    <label for="mensagem2">Mensagem 2:</label>
    <textarea id="mensagem2" placeholder="Mensagem secundária"></textarea>
  </div>

  <div id="divCaminhoImagem" class="hidden">
    <label for="caminhoimagem">Caminho da Imagem:</label>
    <input type="text" id="caminhoimagem" placeholder="Ex: ./imagens/imagem.jpg" />
  </div>

  <div id="divCaminhoBoleto" class="hidden">
    <label for="caminhoBoleto">Caminho do Boleto:</label>
    <input type="text" id="caminhoBoleto" placeholder="Ex: ./boletos/boleto.pdf" />
  </div>

  <button id="btnEnviar">Enviar</button>

  <label>Progresso do envio:</label>
  <progress id="barraProgresso" value="0" max="100" style="width: 100%;"></progress>
  <p id="statusEnvio"></p>

  <h3>Resposta do servidor:</h3>
  <pre id="resposta"></pre>

  <script>
    const campos = {
      imagem: ["divCaminhoImagem"],
      boleto: ["divCaminhoBoleto"],
      "mensagem-dupla": ["divMensagem2"],
      "mensagem-boleto": ["divMensagem2", "divCaminhoBoleto"],
    };

    // URL base - USE A URL DO SEU NGROK
    const BASE_URL = 'https://4fe6c1fe3b8b.ngrok-free.app';

    function atualizarCampos() {
      document.querySelectorAll(".hidden").forEach(el => el.classList.add("hidden"));
      const rota = document.getElementById("rota").value;
      (campos[rota] || []).forEach(id => document.getElementById(id).classList.remove("hidden"));
    }

    // Função para verificar status do WhatsApp
    async function verificarStatusWhatsApp() {
      try {
        console.log('Verificando status do WhatsApp em:', `${BASE_URL}/health`);
        const response = await fetch(`${BASE_URL}/health`, {
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('Resposta não é JSON:', text.substring(0, 200));
          throw new Error('Servidor retornou HTML em vez de JSON. Verifique a URL.');
        }
        
        const data = await response.json();
        console.log('Status recebido:', data);
        
        const statusText = document.getElementById('statusText');
        const statusDetails = document.getElementById('statusDetails');
        const btnConectar = document.getElementById('btnConectarWhatsApp');
        const btnEnviar = document.getElementById('btnEnviar');
        
        if (data.pronto) {
          statusText.textContent = '✅ CONECTADO';
          statusText.className = 'status-indicator status-connected';
          statusDetails.textContent = `WhatsApp conectado e pronto para uso. Envios hoje: ${data.enviosHoje}`;
          btnConectar.textContent = 'Gerenciar Conexão';
          btnConectar.style.backgroundColor = '#28a745';
          btnEnviar.disabled = false;
        } else {
          statusText.textContent = '❌ DESCONECTADO';
          statusText.className = 'status-indicator status-disconnected';
          statusDetails.textContent = data.qrDisponivel 
            ? 'QR Code disponível. Clique em "Conectar WhatsApp" para escanear.' 
            : 'Aguardando geração do QR Code...';
          btnConectar.textContent = 'Conectar WhatsApp';
          btnConectar.style.backgroundColor = '#25D366';
          btnEnviar.disabled = true;
        }
      } catch (error) {
        console.error('Erro ao verificar status:', error);
        document.getElementById('statusText').textContent = '❌ ERRO';
        document.getElementById('statusText').className = 'status-indicator status-disconnected';
        document.getElementById('statusDetails').textContent = `Erro: ${error.message}. Verifique se o servidor está rodando.`;
        document.getElementById('btnEnviar').disabled = true;
      }
    }

    // Botão para abrir página do QR Code
    document.getElementById('btnConectarWhatsApp').addEventListener('click', () => {
      const qrWindow = window.open(`${BASE_URL}/qr-page`, 'whatsapp_qr', 'width=500,height=700,scrollbars=no,resizable=no');
      if (!qrWindow) {
        alert('Popup bloqueado! Por favor, permita popups para este site.');
      }
    });

    // Verificar status a cada 5 segundos
    setInterval(verificarStatusWhatsApp, 5000);
    
    // Verificar status quando a página carregar
    window.addEventListener('load', () => {
      atualizarCampos();
      verificarStatusWhatsApp();
    });

    document.getElementById("rota").addEventListener("change", atualizarCampos);

    document.getElementById("btnEnviar").addEventListener("click", async () => {
      const btn = document.getElementById("btnEnviar");
      btn.disabled = true;

      // Verificar se WhatsApp está conectado
      try {
        const statusResponse = await fetch(`${BASE_URL}/health`);
        const statusData = await statusResponse.json();
        
        if (!statusData.pronto) {
          alert("WhatsApp não está conectado. Por favor, conecte o WhatsApp primeiro.");
          btn.disabled = false;
          return;
        }
      } catch (error) {
        alert("Erro ao verificar status do WhatsApp. Tente novamente.");
        btn.disabled = false;
        return;
      }

      const vendedor = document.getElementById("vendedor").value;
      const tipo = document.getElementById("rota").value;
      const numeros = document.getElementById("numeros").value.split("\n").map(n => n.trim()).filter(Boolean);
      const mensagem1 = document.getElementById("mensagem1").value;
      const mensagem2 = document.getElementById("mensagem2").value;
      const caminhoimagem = document.getElementById("caminhoimagem").value;
      const caminhoBoleto = document.getElementById("caminhoBoleto").value;
      const titulo = document.getElementById("titulo").value;

      if (numeros.length === 0) {
        alert("Por favor, informe pelo menos um número.");
        btn.disabled = false;
        return;
      }

      if (!mensagem1.trim()) {
        alert("Por favor, informe a mensagem.");
        btn.disabled = false;
        return;
      }

      const barra = document.getElementById("barraProgresso");
      const status = document.getElementById("statusEnvio");
      const respostaPre = document.getElementById("resposta");
      barra.value = 0;
      barra.max = numeros.length;
      status.textContent = "Disparando mensagens...";
      respostaPre.textContent = "";

      let resultados = [];
      for (let i = 0; i < numeros.length; i++) {
        try {
          // Enviar a primeira mensagem
          const payload = {
            numeros: [numeros[i]],
            mensagem: mensagem1,
            titulo,
            dadosCliente: {}
          };

          const resp1 = await fetch(`${BASE_URL}/enviar?vendedor=${vendedor}`, {
            method: "POST",
            headers: { 
              "Content-Type": "application/json",
              "Accept": "application/json"
            },
            body: JSON.stringify(payload)
          });
          
          if (!resp1.ok) {
            throw new Error(`HTTP error! status: ${resp1.status}`);
          }
          
          const result1 = await resp1.json();
          resultados.push({ numero: numeros[i], resultado: result1 });

          // Se for mensagem dupla, enviar a segunda mensagem
          if (tipo === "mensagem-dupla" && mensagem2) {
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const resp2 = await fetch(`${BASE_URL}/enviar?vendedor=${vendedor}`, {
              method: "POST",
              headers: { 
                "Content-Type": "application/json",
                "Accept": "application/json"
              },
              body: JSON.stringify({ 
                numeros: [numeros[i]], 
                mensagem: mensagem2, 
                titulo 
              })
            });
            
            if (!resp2.ok) {
              throw new Error(`HTTP error! status: ${resp2.status}`);
            }
            
            const result2 = await resp2.json();
            resultados.push({ numero: numeros[i], resultado: result2 });
          }
        } catch (err) {
          console.error('Erro ao enviar mensagem:', err);
          resultados.push({ numero: numeros[i], resultado: { erro: err.message } });
        }

        barra.value = i + 1;
        status.textContent = `Enviando... (${i + 1}/${numeros.length})`;
        
        // Pequeno delay entre números
        if (i < numeros.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }

      status.textContent = "Envio finalizado.";
      respostaPre.textContent = JSON.stringify(resultados, null, 2);
      btn.disabled = false;
      
      // Atualizar status final
      await verificarStatusWhatsApp();
    });
  </script>
</body>
</html>
