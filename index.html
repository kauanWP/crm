<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Envio de Mensagens WhatsApp</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f2f5;
      padding: 20px;
      max-width: 700px;
      margin: auto;
    }
    h2, h3 {
      color: #333;
    }
    label {
      font-weight: 600;
      margin-top: 10px;
      display: block;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 15px;
      box-sizing: border-box;
      font-size: 15px;
      background-color: #fff;
    }
    textarea {
      resize: vertical;
    }
    button {
      background-color: #007bff;
      color: white;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    button:hover:enabled {
      background-color: #0056b3;
    }
    pre {
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #ddd;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 300px;
      overflow-y: auto;
    }
    #statusEnvio {
      font-weight: bold;
      color: green;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .hidden {
      display: none;
    }
    .btn-small {
      padding: 8px 16px;
      font-size: 14px;
    }
    .small-note {
      color: #666;
      font-size: 14px;
      margin-left: 8px;
      vertical-align: middle;
    }
    .placeholder-text {
      display: inline-block;
      font-weight: 600;
      color: #222;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <h2>Enviar mensagens via WhatsApp</h2>

  <label for="titulo">Título (para arquivo histórico)</label>
  <textarea id="titulo" placeholder="Título da mensagem (opcional)"></textarea>

  <label for="rota">Tipo de Envio:</label>
  <select id="rota">
    <option value="mensagem">Mensagem Simples</option>
    <option value="imagem">Mensagem com Imagem</option>
    <option value="mensagem-dupla">Mensagem Dupla (sem imagem)</option>
    <option value="mensagem-boleto">Mensagem + Boleto + Legenda</option>
    <option value="boleto">Somente Boleto</option>
  </select>

  <label for="vendedor">Deseja Enviar de qual número?:</label>
  <select id="vendedor">
    <option value="Financeiro">Financeiro</option>
  </select>

  <label for="numeros">Números (um por linha):</label>
  <textarea id="numeros" rows="4" placeholder="Ex: 5511999999999"></textarea>

  <label for="mensagem1">Mensagem 1:</label>
  <textarea id="mensagem1" placeholder="Mensagem principal"></textarea>

  <div id="divMensagem2" class="hidden">
    <label for="mensagem2">Mensagem 2:</label>
    <textarea id="mensagem2" placeholder="Mensagem secundária"></textarea>
  </div>

  <div id="divCaminhoImagem" class="hidden">
    <label for="caminhoimagem">Caminho da Imagem:</label>
    <input type="text" id="caminhoimagem" placeholder="Ex: ./imagens/imagem.jpg" />
  </div>

  <div id="divCaminhoBoleto" class="hidden">
    <label for="caminhoBoleto">Caminho do Boleto:</label>
    <input type="text" id="caminhoBoleto" placeholder="Ex: ./boletos/boleto.pdf" />
  </div>

  <button id="btnEnviar">Enviar</button>

  <label>Progresso do envio:</label>
  <progress id="barraProgresso" value="0" max="100" style="width: 100%;"></progress>
  <p id="statusEnvio"></p>

  <h3>Resposta do servidor:</h3>
  <pre id="resposta"></pre>

  <script>
    const campos = {
      imagem: ["divCaminhoImagem"],
      boleto: ["divCaminhoBoleto"],
      "mensagem-dupla": ["divMensagem2"],
      "mensagem-boleto": ["divMensagem2", "divCaminhoBoleto"],
    };

    // Ajuste seu BASE_URL se necessário
    const BASE_URL = 'https://863265fbf0b3.ngrok-free.app';

    function atualizarCampos() {
      document.querySelectorAll(".hidden").forEach(el => el.classList.add("hidden"));
      const rota = document.getElementById("rota").value;
      (campos[rota] || []).forEach(id => document.getElementById(id).classList.remove("hidden"));
    }

    // Não há verificação de /health nem botão de conectar — envio direto
    window.addEventListener('load', () => {
      atualizarCampos();
    });

    document.getElementById("rota").addEventListener("change", atualizarCampos);

    document.getElementById("btnEnviar").addEventListener("click", async () => {
      const btn = document.getElementById("btnEnviar");
      btn.disabled = true;

      const vendedor = document.getElementById("vendedor").value;
      const tipo = document.getElementById("rota").value;
      const numeros = document.getElementById("numeros").value.split("\n").map(n => n.trim()).filter(Boolean);
      const mensagem1 = document.getElementById("mensagem1").value;
      const mensagem2 = document.getElementById("mensagem2").value;
      const caminhoimagem = document.getElementById("caminhoimagem").value;
      const caminhoBoleto = document.getElementById("caminhoBoleto").value;
      const titulo = document.getElementById("titulo").value;

      if (numeros.length === 0) {
        alert("Por favor, informe pelo menos um número.");
        btn.disabled = false;
        return;
      }

      if (!mensagem1.trim()) {
        alert("Por favor, informe a mensagem.");
        btn.disabled = false;
        return;
      }

      const barra = document.getElementById("barraProgresso");
      const status = document.getElementById("statusEnvio");
      const respostaPre = document.getElementById("resposta");
      barra.value = 0;
      barra.max = numeros.length;
      status.textContent = "Disparando mensagens...";
      respostaPre.textContent = "";

      let resultados = [];
      for (let i = 0; i < numeros.length; i++) {
        try {
          // Enviar a primeira mensagem
          const payload = {
            numeros: [numeros[i]],
            mensagem: mensagem1,
            titulo,
            dadosCliente: {}
          };

          const resp1 = await fetch(`${BASE_URL}/enviar?vendedor=${encodeURIComponent(vendedor)}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          
          if (!resp1.ok) {
            let erroBody;
            try { erroBody = await resp1.text(); } catch (e) { erroBody = resp1.statusText; }
            throw new Error(`HTTP error! status: ${resp1.status} - ${erroBody}`);
          }
          
          const result1 = await resp1.json();
          resultados.push({ numero: numeros[i], resultado: result1 });

          // Se for mensagem dupla, enviar a segunda mensagem
          if (tipo === "mensagem-dupla" && mensagem2) {
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            const resp2 = await fetch(`${BASE_URL}/enviar?vendedor=${encodeURIComponent(vendedor)}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                numeros: [numeros[i]], 
                mensagem: mensagem2, 
                titulo 
              })
            });
            
            if (!resp2.ok) {
              let erroBody2;
              try { erroBody2 = await resp2.text(); } catch (e) { erroBody2 = resp2.statusText; }
              throw new Error(`HTTP error! status: ${resp2.status} - ${erroBody2}`);
            }
            
            const result2 = await resp2.json();
            resultados.push({ numero: numeros[i], resultado: result2 });
          }
        } catch (err) {
          console.error('Erro ao enviar mensagem:', err);
          resultados.push({ numero: numeros[i], resultado: { erro: err.message } });
        }

        barra.value = i + 1;
        status.textContent = `Enviando... (${i + 1}/${numeros.length})`;
        
        // Pequeno delay entre números
        if (i < numeros.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }

      status.textContent = "Envio finalizado.";
      respostaPre.textContent = JSON.stringify(resultados, null, 2);
      btn.disabled = false;
    });
  </script>
</body>
</html>
